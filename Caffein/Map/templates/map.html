{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caffein</title>
    <link rel="stylesheet" href="{% static 'css/map.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">
</head>

<body>
    <header>
        <div id="nav">
            <div class="map_btn-wrapper">
                <image src="/static/map.png" class="mapbtn"></image>
            </div>
            <a href="{% url 'store_list' %}">
                <div class="list-btn-wrapper">
                    <i class="fas fa-list-ul"></i>
                </div>
            </a>

            <div class="user-btn-wrapper">
                <image src="/static/user 2.png" class="userbtn"></image>
            </div>

        </div>
    </header>

    <section>
        <div id="main">
            <div class="search-bar-position">
                <div class="search-bar-wrapper">
                    <input type="text" id="search-bar" placeholder="ì¥ì†Œë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”">
                    <image src="static/search.png" id="search-btn"></image>

                </div>

            </div>
            <div class="category-bar-position">
                <div class="category-bar-wrapper">
                    <a href="#">ì „ì²´</a>
                    <a href="#">ë§Œë“¤ê¸°ê°€ ì¢‹ì€</a>
                    <a href="#">ì•¼ì˜¹ì´ê°€ ì¢‹ì€</a>
                    <a href="#">ì½˜ì„¼íŠ¸ê°€ ì¢‹ì€</a>
                    <a href="#">ì•„ì¹¨ë¨¹ê¸° ì¢‹ì€</a>
                    <a href="#">ì €ë…ë¨¹ê¸° ì¢‹ì€</a>
                    <a href="#">ì ì‹¬ë¨¹ê¸° ì¢‹ì€</a>
                    <a href="#">ì•¼ë°œ..</a>
                </div>
            </div>
            <div id="map"></div>

        </div>
        <div class="center-btn-wrapper">
            <i class="fas fa-crosshairs center"></i>
        </div>
        <!--ë§ˆì»¤ì„ íƒì‹œ ëª¨ë‹¬ì°½-->

        <div class="modal-wrap">
            <div class="modal-size-btn">
                <image src="/static/upmarker.png" id="modalup"></image>
            </div>
            <div class="modal-content-wrap">

                <div class="modal-close">X</div>

                <div class="modal-content">
                    <div class="modal-notclicked">

                    </div>
                </div>


            </div>
        </div>

        </div>
        </div>

    </section>


    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=55fb65a388899694dad0a54acca653e6&libraries=services"></script>
    <script>
        var infowindow = new kakao.maps.InfoWindow({ zIndex: 3 });
        var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div 
            mapOption = {
                center: new kakao.maps.LatLng(35.231627, 129.084338), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
                level: 3 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
            };

        // ì§€ë„ë¥¼ í‘œì‹œí•  divì™€  ì§€ë„ ì˜µì…˜ìœ¼ë¡œ  ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
        var map = new kakao.maps.Map(mapContainer, mapOption);


        if (navigator.geolocation) {

            // GeoLocationì„ ì´ìš©í•´ì„œ ì ‘ì† ìœ„ì¹˜ë¥¼ ì–»ì–´ì˜µë‹ˆë‹¤
            navigator.geolocation.getCurrentPosition(function (position) {

                var lat = position.coords.latitude, // ìœ„ë„
                    lon = position.coords.longitude; // ê²½ë„

                var locPosition = new kakao.maps.LatLng(lat, lon); // ë§ˆì»¤ê°€ í‘œì‹œë  ìœ„ì¹˜ë¥¼ geolocationìœ¼ë¡œ ì–»ì–´ì˜¨ ì¢Œí‘œë¡œ ìƒì„±í•©ë‹ˆë‹¤

                // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ
                mylocMarker(locPosition);

            });

        } else { // HTML5ì˜ GeoLocationì„ ì‚¬ìš©í•  ìˆ˜ ì—†ì„ë•Œ ë§ˆì»¤ í‘œì‹œ ìœ„ì¹˜ì™€ ì¸í¬ìœˆë„ìš° ë‚´ìš©ì„ ì„¤ì •í•©ë‹ˆë‹¤

            var locPosition = new kakao.maps.LatLng(33.450701, 126.570667);
            alert("geolocationì„ ì‚¬ìš©í• ìˆ˜ ì—†ì–´ìš”")

            mylocMarker(locPosition, message);
        }
        var imageSrc = '/static/myloc.png'
        var imageSize = new kakao.maps.Size(20, 20);
        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);
        function mylocMarker(locPosition) {
            var marker = new kakao.maps.Marker({
                map: map,
                position: locPosition,
                image: markerImage
            });



            // ì§€ë„ ì¤‘ì‹¬ì¢Œí‘œë¥¼ ì ‘ì†ìœ„ì¹˜ë¡œ ë³€ê²½í•©ë‹ˆë‹¤
            // map.setCenter(locPosition);      
        }
        //ë§ˆì»¤ ì´ë¯¸ì§€ ë³€ê²½ 

        function myloc() {
            // ì´ë™í•  ìœ„ë„ ê²½ë„ ìœ„ì¹˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤ 
            navigator.geolocation.getCurrentPosition(function (position) {

                var lat = position.coords.latitude, // ìœ„ë„
                    lon = position.coords.longitude; // ê²½ë„

                var locPosition = new kakao.maps.LatLng(lat, lon)


                // ì§€ë„ ì¤‘ì‹¬ì„ ë¶€ë“œëŸ½ê²Œ ì´ë™ì‹œí‚µë‹ˆë‹¤
                // ë§Œì•½ ì´ë™í•  ê±°ë¦¬ê°€ ì§€ë„ í™”ë©´ë³´ë‹¤ í¬ë©´ ë¶€ë“œëŸ¬ìš´ íš¨ê³¼ ì—†ì´ ì´ë™í•©ë‹ˆë‹¤
                map.panTo(locPosition);
            });
        }

        // ë‚´ìœ„ì¹˜ë¡œ ì´ë™í•˜ê¸° ë²„íŠ¼
        let center_btn = document.querySelector(".center");
        var len_marker;

        center_btn.addEventListener("click", myloc);

        var markers = [];

        var info = [];


        {% for cafe in cafe_list %}
        //ì¢Œí‘œ ë˜ì ¸ì£¼ëŠ” ë³€ìˆ˜
        var position = new kakao.maps.LatLng({{ cafe.y }}, {{ cafe.x }});
        info.push({ 'name': '{{cafe.name}}', 'x': '{{cafe.x}}', 'y': '{{cafe.y}}' });
        markers.push(position);
        {% endfor %}

        len_marker = markers.length;



        window.onload = function () {
            function onClick() {
                var modal_noclick = document.querySelector('.modal-notclicked')
                var modal = document.querySelector('.modal-wrap');
                var center_btn_move = document.querySelector('.center-btn-wrapper');
                var navbar = document.querySelector('#nav');
                navbar.style.display = 'none';
                modal.style.display = 'block';
                center_btn_move.style.bottom = '34%';
                console.log(event.currentTarget.id)
                {% for cafe in cafe_list %}
                if (event.currentTarget.id == 'daum.maps.Marker.Area:{{forloop.counter}}') {
                    // modal_content.innerHTML = "<div class='cafe_card_img'>" + "<img src='{{cafe.image.url}}'>" + "</div>" + "<div class='cafe_card_content_wrap'>" + "<div class='cafe_card_story'>" + "<img src='{{cafe.story}}'>" + "</div>" + "<div class='cafe_card_content'>" + "<div class='cafe_card_title'>" + "{{cafe.name}}" + "</div>" + "<div class='cafe_card_loc'>" + "ğŸ“ŒCAFE ADDRESS<br>{{cafe.address}}</div>" + " <div class='cafe_card_time'>" + "â°OPENING HOURS<br>" + " {{cafe.open_time}}</div>" + "</div>" + "<div class='cafe_card_like'>â™¡10</div>" + "</div>"

                    modal_content.innerHTML="<img class='store-image' src='{{cafe.image.url}}'>"+
                                            "<div class='store-info'>"+
                                                "<div class='store-profile'>"+"</div>"+
                                                "<div class='store-text'>"+
                                                    "<h3>{{cafe}}</h3><br>"+
                                                    "{{cafe.address}}<br>"+
                                                    "{{cafe.phone_number}}<br>"+                                              
                                                    "{{cafe.sns}}"
                                                +"</div>"
                                            +"</div>"
                }

                {% endfor %}
            }
            function offClick() {
                var modal = document.querySelector('.modal-wrap');
                var center_btn_move = document.querySelector('.center-btn-wrapper');
                var navbar = document.querySelector('#nav');
                modal.style.display = 'none';
                center_btn_move.style.bottom = '18%';
                navbar.style.display = 'flex';
            }

            //for (var i = 1; i <= len_marker; i++ ){
            {% for cafe in cafe_list %}
            var modal_btn = document.getElementById('daum.maps.Marker.Area:' + {{ forloop.counter }});
        modal_btn.addEventListener('click', onClick);
        {% endfor %}

        // };
        document.querySelector('.modal-close').addEventListener('click', offClick);
    
};

        var modal_content = document.querySelector('.modal-content');

        //ì§€ë„ì— ë§ˆì»¤í‘œì‹œ
        function displayMarker(i) {

            var marker = new kakao.maps.Marker({
                map: map,
                position: markers[i],
                clickable: true,
            });

            kakao.maps.event.addListener(marker, 'click', function () {
                loc = marker.getPosition();
                map.panTo(loc)
                infowindow.setContent('<div style="padding:5px;font-size:12px;">' + JSON.stringify(info[i].name) + '</div>');
                infowindow.open(map, marker);
            });
        };


        for (var i = 0; i < markers.length; i++) {
            displayMarker(i);
        }


        //í‚¤ì›Œë“œ ì„œì¹˜
        let search_btn = document.querySelector("#search-btn");
        let search_bar = document.querySelector("#search-bar");

        search_btn.addEventListener("click", () => {
            let keyword = search_bar.value;
            if (keyword) {
                keywordSearch(keyword);
                console.log(keyword + "ê²€ìƒ‰í•˜ì…¨ìŠµë‹ˆë‹¤");

            } else {
                alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
            }
        });

        search_bar.addEventListener("keyup", () => {
            if (event.keyCode === 13) {
                search_btn.click();
            }
        });

        var ps = new kakao.maps.services.Places();

        // í‚¤ì›Œë“œë¡œ ì¥ì†Œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤
        function keywordSearch(keyword) {
            ps.keywordSearch(keyword, placesSearchCB);
        }


        // í‚¤ì›Œë“œ ê²€ìƒ‰ ì™„ë£Œ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°±í•¨ìˆ˜ ì…ë‹ˆë‹¤
        function placesSearchCB(data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {

                // ê²€ìƒ‰ëœ ì¥ì†Œ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ë„ ë²”ìœ„ë¥¼ ì¬ì„¤ì •
                let center = new kakao.maps.LatLng(data[0].y, data[0].x);

                map.setCenter(center);
            };
        }

        //ëª¨ë‹¬ ì‚¬ì´ì¦ˆ ì¡°ì •
        var doc = document,
            main = document.querySelector(".modal-wrap"),
            ht = 185,
            y, dy;

        var startResize = function (evt) {
            y = evt.screenY;
        };
        var resize = function (evt) {
            dy = evt.screenY - y;//ë§ˆìš°ìŠ¤ ì´ë™ ì´ë²¤íŠ¸ ë°œìƒì‹œì˜ ìŠ¤í¬ë¦°ìƒ yí”½ì…€ê°’ - ì´ì „ í”½ì…€ê°’ -> ì´ë™ í”½ì…€ê°’ ê³„ì‚°
            y = evt.screenY;//ì‹œì‘ yê°’ ì¬ì„¤ì •
            ht -= dy;//ì´ë™ í”½ì…€ê°’ ë”í•´ì¤Œ
            main.style.height = ht + "px";

        };

        var size_btn = document.querySelector(".modal-size-btn");
        size_btn.addEventListener("mousedown", function (evt) {
            startResize(evt);
            doc.body.addEventListener("mousemove", resize);
            doc.body.addEventListener("mouseup", function () {
                doc.body.removeEventListener("mousemove", resize);
                modal_resize(function () {
                    ht = main.style.height;
                });
            });
        });
        function modal_resize() {

            if (ht > 300) {
                main.style.height = '660px';

            } else {
                main.style.height = '185px';
            };
        };

    </script>
</body>

</html>